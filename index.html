<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ECMO レジストリ入力フォーム</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <style>
    label, input, select, button, span { font-size: 1em; }
    fieldset { margin-bottom: 20px; }
    th, td { white-space: pre-line; word-break: break-all; }
    button { margin: 8px 0; }
    .delete-request-status {
      margin-top: 8px;
      font-size: 0.9em;
      white-space: pre-line;
    }
    .delete-request-status--info {
      color: #0b8043;
    }
    .delete-request-status--warn {
      color: #e37400;
    }
    .delete-request-status--error {
      color: #d93025;
    }

  </style>
</head>
<body>
  <h1>ECMO レジストリ入力フォーム</h1>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var placeholderPattern = /\[\u6dfb\u524a\u3057\u3066\u306d\]/g;

      var textNodesToClean = [];
      var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
      while (walker.nextNode()) {
        var node = walker.currentNode;
        if (typeof node.nodeValue === 'string') {
          placeholderPattern.lastIndex = 0;
          if (placeholderPattern.test(node.nodeValue)) {
            textNodesToClean.push(node);
          }
        }
      }

      for (var i = 0; i < textNodesToClean.length; i += 1) {
        var textNode = textNodesToClean[i];
        placeholderPattern.lastIndex = 0;
        textNode.nodeValue = textNode.nodeValue.replace(placeholderPattern, '');
      }

      var allElements = document.querySelectorAll('*');
      for (var j = 0; j < allElements.length; j += 1) {
        var element = allElements[j];
        var attrs = element.attributes;
        for (var k = 0; k < attrs.length; k += 1) {
          var attr = attrs[k];
          placeholderPattern.lastIndex = 0;
          if (placeholderPattern.test(attr.value)) {
            placeholderPattern.lastIndex = 0;
            attr.value = attr.value.replace(placeholderPattern, '');
          }
        }
      }
    });
  </script>

  <fieldset>
    <legend>患者情報</legend>
<label>病院名：</label>
    <select id="hospital">
      <optgroup label="北海道">
        <option value="hokkaido_univ">北海道大学病院（北海道）</option>
        <option value="teine">手稲渓仁会病院（北海道）</option>
        <option value="asahikawa_med">旭川医科大学病院（北海道）</option>
        <option value="hokkaido_child">北海道立こども総合医療・療育センター（北海道）</option>
      </optgroup>
      <optgroup label="東北地方">
        <option value="hirosaki">弘前大学医学部附属病院（青森県）</option>
        <option value="iwate">岩手医科大学附属病院（岩手県）</option>
        <option value="miyagi_child">宮城県立こども病院（宮城県）</option>
        <option value="tohoku">東北大学病院（宮城県）</option>
        <option value="akita">秋田大学医学部附属病院（秋田県）</option>
        <option value="yamagata">山形大学医学部附属病院（山形県）</option>
        <option value="fukushima">福島県立医科大学附属病院（福島県）</option>
      </optgroup>
      <optgroup label="関東地方">
        <option value="ncchd">国立成育医療研究センター（東京都）</option>
        <option value="utokyo">東京大学医学部附属病院（東京都）</option>
        <option value="womens_med">東京女子医科大学病院（東京都）</option>
        <option value="sakakibara">榊原記念病院（東京都）</option>
        <option value="juntendo">順天堂大学医学部附属順天堂医院（東京都）</option>
        <option value="tmd">東京医科歯科大学医学部附属病院（東京都）</option>
        <option value="keio">慶應義塾大学病院（東京都）</option>
        <option value="nms">日本医科大学付属病院（東京都）</option>
        <option value="tmhp">東京都立小児総合医療センター（東京都）</option>
        <option value="saitama_int">埼玉医科大学国際医療センター（埼玉県）</option>
        <option value="saitama_child">埼玉県立小児医療センター（埼玉県）</option>
        <option value="chiba_child">千葉県こども病院（千葉県）</option>
        <option value="chiba_univ">千葉大学医学部附属病院（千葉県）</option>
        <option value="kanagawa_child">神奈川県立こども医療センター（神奈川県）</option>
        <option value="kitasato">北里大学病院（神奈川県）</option>
        <option value="yokohama_city">横浜市立大学附属病院（神奈川県）</option>
      </optgroup>
      <optgroup label="中部地方">
        <option value="niigata">新潟大学医歯学総合病院（新潟県）</option>
        <option value="nagano_child">長野県立こども病院（長野県）</option>
        <option value="gifu">岐阜県総合医療センター（岐阜県）</option>
        <option value="nagoya_univ">名古屋大学医学部附属病院（愛知県）</option>
        <option value="shizuoka_child">静岡こども病院（静岡県）</option>
        <option value="aichi_child">あいち小児保険医療総合病院（愛知県）</option>
      </optgroup>
      <optgroup label="近畿地方">
        <option value="kyoto_univ">京都大学医学部附属病院（京都府）</option>
        <option value="kyoto_pref">京都府立医科大学附属病院（京都府）</option>
        <option value="osaka_univ">大阪大学医学部附属病院（大阪府）</option>
        <option value="osaka_mother">大阪母子医療センター（大阪府）</option>
        <option value="ncvc">国立循環器病研究センター（大阪府）</option>
      </optgroup>
      <optgroup label="中国・四国地方">
        <option value="okayama">岡山大学病院（岡山県）</option>
        <option value="ehime">愛媛大学医学部附属病院（愛媛県）</option>
        <option value="hyogo">兵庫県立こども病院（兵庫県）</option>
      </optgroup>
      <optgroup label="九州・沖縄地方">
        <option value="kyushu_univ">九州大学病院（福岡県）</option>
        <option value="fukuoka_child">福岡こども病院（福岡県）</option>
        <option value="kumamoto_univ">熊本大学医学部附属病院（熊本県）</option>
        <option value="kumamoto_red">熊本赤十字病院（熊本県）</option>
        <option value="nanbu">南部医療センター（沖縄県）</option>
        <option value="ryukyu">琉球大学病院（沖縄県）</option>
      </optgroup>
    </select><br><br>

    <label>ID：</label>
    <input type="number" id="case_id" placeholder="例: 1">
    <small>※ 入力順に1,2,3と順に番号を振ってください。1分でもECMOを離脱した場合は、新たな症例（ID）として登録してください。</small><!-- コメント: ECMOを一度離脱したら新規ID扱い --><br><br>

    <label>性別：</label>
    <select id="sex">
      <option value="M" selected>男</option>
      <option value="F">女</option>
    </select><br><br>

    <label>生年月日：</label>
    <input type="date" id="dob">
    <div>
     <label>年齢：</label>
     <span id="age_display">（未計算）</span>
    </div><br>
    
    <div>
     <label>日齢：</label>
     <span id="days_old_display"></span> 日
    </div>
    <div>
     <label>新生児：</label>
     <span id="neonate_flag">N</span>　
     <label>小児：</label>
     <span id="pediatric_flag">N</span>
    </div><br>

    <label>体重（kg）：</label>
    <input type="number" step="0.1" id="weight" placeholder="例: 3.2"><br><br>
  </fieldset><br>

  <fieldset>
    <legend>ECMO適応</legend>
    <label>エクモ適応病態：</label>
    <select id="ecmo_type">
      <option value="respiratory">呼吸性（respiratory）</option>
      <option value="cardiac">心原性（cardiac）</option>
      <option value="ecpr">ECPR</option>
    </select><br><br>

<label>ECMOを必要とした病名（ICD-10ベース・複数選択可）：</label><br>
<div id="diagnosis_section">
  <div id="diagnosis_respiratory" style="display:none">
    <label><input type="checkbox" name="icd10_codes" value="Q79.0"> 先天性横隔膜ヘルニア（Q79.0）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="P24.0"> 胎便吸引症候群（P24.0）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="P29.3"> 新生児遷延性肺高血圧症（P29.3）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="P22.0"> 呼吸窮迫症候群（P22.0）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="A41.9"> 敗血症（A41.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="J45"> 喘息（J45）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="J21.9"> 細気管支炎（J21.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="J12.9"> ウイルス性肺炎（J12.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="J69.0"> 誤嚥性肺炎（J69.0）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="J15.9"> 細菌性肺炎（J15.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="J18.9"> その他の肺炎（J18.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="A37"> 百日咳（A37）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="J96.0"> 急性呼吸不全（J96.0）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="P27.1"> 慢性肺疾患（P27.1）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="P26"> 肺出血（P26）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="T75.1"> 溺水（T75.1）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="T17.9"> 吸引（T17.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="T17"> 異物（T17）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="T81.9"> 術後または外傷（T81.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="chd"> 先天性心疾患（Q20-Q28）</label><br>
  </div>

  <div id="diagnosis_cardiac" style="display:none">
    <label><input type="checkbox" name="icd10_codes" value="chd"> 先天性心疾患</label><br>
    <label><input type="checkbox" name="icd10_codes" value="Q20.4"> 単心室症候群（Q20.4）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="Q25.2"> 左心流出路閉塞（Q25.2）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="Q22.1"> 右心流出路閉塞（Q22.1）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="Q21.0"> 心室中隔欠損（Q21.0）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="Q21.8"> 肺血流減少型チアノーゼ心疾患（Q21.8）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="I46.9"> 心停止（I46.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="R57.0"> 心原性ショック（R57.0）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="I42.9"> 心筋症（I42.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="I40.9"> 心筋炎（I40.9）</label><br>
    <label><input type="checkbox" name="icd10_codes" value="R99"> その他（R99）</label><br>
  </div>

  <div id="diagnosis_ecpr" style="display:none">
    <label>任意ICD-10コード入力（日本基準ではなくWHO基準でお願いします）：</label>
    <input type="text" id="ecpr_icd10_code" placeholder="例：I46.9 心停止、不明">
    <a href="https://icd.who.int/browse10/2019/en" target="_blank">ICD-10検索</a>
    <br><br>

    <label>心停止場所：</label>
    <select id="arrest_location">
      <option value="or">手術室</option>
      <option value="icu">ICU</option>
      <option value="er">救急処置室</option>
      <option value="ward">一般病棟</option>
      <option value="transport">搬送中</option>
      <option value="out">院外</option>
      <option value="unknown">不明</option>
    </select><br><br>

    <label>心停止の目撃者：</label>
    <select id="witnessed">
      <option value="Y">Y</option>
      <option value="N">N</option>
    </select><br><br>

    <label>ECMOカニュレーション場所：</label>
    <select id="cannulation_location">
      <option value="or">手術室</option>
      <option value="icu">ICU</option>
      <option value="er">救急処置室</option>
      <option value="cath_lab">心臓カテーテル室</option>
      <option value="other">その他</option>
      <option value="unknown">不明</option>
    </select><br><br>

    <label>ECMO回路充填液：</label>
    <select id="priming_fluid">
      <option value="blood">血液</option>
      <option value="crystalloid">細胞外液</option>
      <option value="other">その他</option>
      <option value="unknown">不明</option>
    </select><br><br>

    <label>低体温療法：</label>
    <select id="hypothermia">
      <option value="Y">Y</option>
      <option value="N">N</option>
    </select><br><br>

    <label>CPRを行った時間（分）：</label>
    <input type="number" id="cpr_duration" placeholder="例: 45"><br><br>
  </div>

  </div><br>
  </fieldset><br>

  <script>
    window.addEventListener('DOMContentLoaded', function () {
      var ecmoType = document.getElementById("ecmo_type");
      var diagnosisResp = document.getElementById("diagnosis_respiratory");
      var diagnosisCard = document.getElementById("diagnosis_cardiac");
      var diagnosisEcpr = document.getElementById("diagnosis_ecpr");

      function updateDiagnosisVisibility() {
        diagnosisResp.style.display = ecmoType.value === "respiratory" ? "block" : "none";
        diagnosisCard.style.display = ecmoType.value === "cardiac" ? "block" : "none";
        diagnosisEcpr.style.display = ecmoType.value === "ecpr" ? "block" : "none";
      }

      ecmoType.addEventListener("change", updateDiagnosisVisibility);
      updateDiagnosisVisibility();
    });
  </script>

  <fieldset>
    <legend>ECMO情報</legend>
    <label>ECMO形式：</label>
    <select id="ecmo_mode">
      <option value="va" selected>V-A</option>
      <option value="vv">V-V</option>
      <option value="other">その他</option>
    </select><br><br>

    <label>ポンプの種類：</label>
    <select id="pump_type">
      <option value="centrifugal" selected>遠心</option>
      <option value="roller">ローラー</option>
      <option value="other">その他</option>
    </select><br><br>

    <label>人工肺の種類：</label>
    <select id="oxygenator">
      <option value="composite" selected>複合膜</option>
      <option value="pmp">ポリメチルペンテン</option>
      <option value="silicone">シリコン</option>
    </select><br><br>

    <label>ECMO導入日：</label>
    <input type="date" id="ecmo_start_date"><br>
    <div id="calculated_age"></div><br>

    <label>ECMO離脱日：</label>
    <input type="date" id="ecmo_end_date"><br>
    <div id="ecmo_days"></div><br>
   
    <div><strong>ECMO使用日数：</strong> <span id="ecmo_days_display">-</span> 日</div><br>
    
    <!-- 抗凝固薬（複数回答可） -->
    <label><strong>抗凝固薬（複数回答可）：</strong></label><br>
    <label><input type="checkbox" name="anticoagulants" value="未分化ヘパリン"> 未分化ヘパリン</label><br>
    <label><input type="checkbox" name="anticoagulants" value="ナファモスタットメシル酸塩"> ナファモスタットメシル酸塩</label><br>
    <label><input type="checkbox" name="anticoagulants" value="その他"> その他</label><br><br>

    <!-- 抗凝固薬を調整する指標（複数回答可） -->
    <label><strong>抗凝固薬調整指標（複数回答可）：</strong></label><br>
    <label><input type="checkbox" name="anticoag_monitoring" value="APTT"> APTT</label><br>
    <label><input type="checkbox" name="anticoag_monitoring" value="ACT"> ACT</label><br>
    <label><input type="checkbox" name="anticoag_monitoring" value="CK-CKH R(TEG6s®)"> CK-CKH R(TEG6s®)</label><br>
    <label><input type="checkbox" name="anticoag_monitoring" value="その他"> その他</label><br><br>

  </fieldset><br>

  <fieldset>
    <legend>転機</legend>

    <label>ICU退室時生存：</label>
    <select id="icu_survival">
      <option value="Y" selected>Y</option>
      <option value="N">N</option>
    </select><br><br>

    <label>ICU退室日：</label>
    <input type="date" id="icu_discharge_date"><br><br>

    <label>病院退院時生存：</label>
    <select id="hospital_survival">
      <option value="Y" selected>Y</option>
      <option value="N">N</option>
    </select><br><br>

    <label>病院退院日：</label>
    <input type="date" id="hospital_discharge_date"><br><br>

    <!-- ECMO離脱後24時間生存 -->
    <label>ECMO離脱後24h生存：</label>
    <select id="ecmo_24h_survival">
      <option value="Y" selected>Y</option>
      <option value="N">N</option>
    </select><br><br>

    <!-- ECMO離脱理由（複数選択可） -->
    <label>ECMO離脱理由：</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="不明"> 不明</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="回復"> 回復</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="予後不良"> 予後不良</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="医療資源不足"> 医療資源不足</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="合併症制御不能"> ECMOの合併症がコントロール不能（エクモのデバイス・マシントラブルを含む）</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="VAD"> VADへの移行</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="PLA"> Pumpless Lung Assistへの移行</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="心移植"> 心移植</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="肺移植"> 肺移植</label><br>
    <label><input type="checkbox" name="ecmo_off_reason" value="心肺移植"> 心臓＋肺移植</label><br><br>

  </fieldset><br>


 <!-- 合併症セクション -->
  <fieldset>
    <legend>合併症</legend>
    <p><small>備考：①複数回同欄の合併症があった場合、初回の合併症日時を入力してください。②ECMO試行期間中に新たに発生した、またはECMOによって悪化した有害事象、またはECMO中発症と臨床的に推測されるものを入力してください。</small></p>
    <h4>機械的合併症（Mechanical）</h4>

    <label>人工肺不良：
      <select id="oxygenator_failure">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：酸素化不良または血栓形成による交換を要した）</span>
      <input type="date" id="oxygenator_failure_date" class="complication-date">
    </label><br>

    <label>ポンプ不良：
      <select id="pump_failure">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：モーター・回転異常などで交換を要した）</span>
      <input type="date" id="pump_failure_date" class="complication-date">
    </label><br>

    <label>カニューレの問題：
      <select id="cannula_problem">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：位置不良・閉塞・脱落など）</span>
      <input type="date" id="cannula_problem_date" class="complication-date">
    </label><br>

    <label>空気塞栓：
      <select id="air_embolism">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：回路内に空気が混入し介入が必要だった場合）</span>
      <input type="date" id="air_embolism_date" class="complication-date">
    </label><br>

    <h4>患者関連合併症（Patient）</h4>

    <label>けいれん（EEG）：
      <select id="seizure">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：脳波で確認された臨床けいれん）</span>
      <input type="date" id="seizure_date" class="complication-date">
    </label><br>

    <label>脳梗塞：
      <select id="stroke">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：画像により確認された）</span>
      <input type="date" id="stroke_date" class="complication-date">
    </label><br>

    <label>頭蓋内出血（CT/MRI）：
      <select id="ich_ct">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：CT/MRIで確認された出血）</span>
      <input type="date" id="ich_ct_date" class="complication-date" style="display:none;">
    </label><br>

    <label>頭蓋内出血（エコー）：
      <select id="ich_echo">
        <option value="X" selected>X</option>
        <option value="N">N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：エコーで確認された出血 [X: 検査未実施または不明]）</span>
      <input type="date" id="ich_echo_date" class="complication-date" style="display:none;">
    </label><br>

    <label>脳死：
      <select id="brain_death">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：脳死判定がなされた場合）</span>
      <input type="date" id="brain_death_date" class="complication-date">
    </label><br>

    <label>心タンポナーデ：
      <select id="tamponade">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：エコー等で確認された心嚢液貯留により介入が必要）</span>
      <input type="date" id="tamponade_date" class="complication-date">
    </label><br>

    <label>カニュレーション部出血：
      <select id="cannula_bleeding">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：圧迫・再縫合等の処置が必要な出血）</span>
      <input type="date" id="cannula_bleeding_date" class="complication-date">
    </label><br>

    <label>消化管出血：
      <select id="gi_bleed">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：吐血・下血あり、介入または輸血を要した）</span>
      <input type="date" id="gi_bleed_date" class="complication-date">
    </label><br>

    <label>四肢切断：
      <select id="amputation">
        <option value="N" selected>N</option>
        <option value="Y">Y</option>
      </select>
      <span>（定義：虚血や感染により切断を要した場合）</span>
      <input type="date" id="amputation_date" class="complication-date">
    </label><br>
  </fieldset>
  <script>
    window.regionMap = {
      "北海道大学病院（北海道）": "北海道", "手稲渓仁会病院（北海道）": "北海道",
      "旭川医科大学病院（北海道）": "北海道", "北海道立こども総合医療・療育センター（北海道）": "北海道",
      "弘前大学医学部附属病院（青森県）": "東北", "岩手医科大学附属病院（岩手県）": "東北",
      "宮城県立こども病院（宮城県）": "東北", "東北大学病院（宮城県）": "東北",
      "秋田大学医学部附属病院（秋田県）": "東北", "山形大学医学部附属病院（山形県）": "東北",
      "福島県立医科大学附属病院（福島県）": "東北",
      "国立成育医療研究センター（東京都）": "関東", "東京大学医学部附属病院（東京都）": "関東",
      "東京女子医科大学病院（東京都）": "関東", "榊原記念病院（東京都）": "関東",
      "順天堂大学医学部附属順天堂医院（東京都）": "関東", "東京医科歯科大学医学部附属病院（東京都）": "関東",
      "慶應義塾大学病院（東京都）": "関東", "日本医科大学付属病院（東京都）": "関東",
      "東京都立小児総合医療センター（東京都）": "関東", "埼玉医科大学国際医療センター（埼玉県）": "関東",
      "埼玉県立小児医療センター（埼玉県）": "関東", "千葉県こども病院（千葉県）": "関東",
      "千葉大学医学部附属病院（千葉県）": "関東", "神奈川県立こども医療センター（神奈川県）": "関東",
      "北里大学病院（神奈川県）": "関東", "横浜市立大学附属病院（神奈川県）": "関東",
      "新潟大学医歯学総合病院（新潟県）": "中部", "長野県立こども病院（長野県）": "中部",
      "岐阜県総合医療センター（岐阜県）": "中部", "名古屋大学医学部附属病院（愛知県）": "中部",
      "静岡こども病院（静岡県）": "中部", "あいち小児保険医療総合病院（愛知県）": "中部",
      "京都大学医学部附属病院（京都府）": "近畿", "京都府立医科大学附属病院（京都府）": "近畿",
      "大阪大学医学部附属病院（大阪府）": "近畿", "大阪母子医療センター（大阪府）": "近畿",
      "国立循環器病研究センター（大阪府）": "近畿", "岡山大学病院（岡山県）": "中国・四国",
      "愛媛大学医学部附属病院（愛媛県）": "中国・四国", "兵庫県立こども病院（兵庫県）": "中国・四国",
      "九州大学病院（福岡県）": "九州・沖縄", "福岡こども病院（福岡県）": "九州・沖縄",
      "熊本大学医学部附属病院（熊本県）": "九州・沖縄", "熊本赤十字病院（熊本県）": "九州・沖縄",
      "南部医療センター（沖縄県）": "九州・沖縄", "琉球大学病院（沖縄県）": "九州・沖縄"
    };
  </script>

  <script>
  function updateEcmoDays() {
    var startInput = document.getElementById("ecmo_start_date");
    var endInput = document.getElementById("ecmo_end_date");
    var display = document.getElementById("ecmo_days_display");
    if (!startInput || !endInput || !display) {
      return;
    }

    var startStr = startInput.value;
    var endStr = endInput.value;
    if (!startStr || !endStr) {
      display.textContent = "-";
      return;
    }

    var start = new Date(startStr);
    var end = new Date(endStr);
    if (isNaN(start) || isNaN(end) || end < start) {
      display.textContent = "日付エラー";
      return;
    }

    var diffDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
    display.textContent = diffDays;
  }
  document.addEventListener("DOMContentLoaded", function () {
    var startInput = document.getElementById("ecmo_start_date");
    var endInput = document.getElementById("ecmo_end_date");
    if (startInput) {
      startInput.addEventListener("change", updateEcmoDays);
    }
    if (endInput) {
      endInput.addEventListener("change", updateEcmoDays);
    }
  });
</script>

<script>
  function calculateAgeAndFlags() {
    var dobInput = document.getElementById("dob");
    var ecmoInput = document.getElementById("ecmo_start_date");
    var ageDisplay = document.getElementById("age_display");
    var daysOldDisplay = document.getElementById("days_old_display");
    var neonateFlag = document.getElementById("neonate_flag");
    var pediatricFlag = document.getElementById("pediatric_flag");

    if (!dobInput || !ecmoInput || !ageDisplay || !daysOldDisplay || !neonateFlag || !pediatricFlag) {
      return;
    }

    var dob = dobInput.value;
    var ecmoDate = ecmoInput.value;

    if (!dob || !ecmoDate) {
      ageDisplay.textContent = "（未計算）";
      daysOldDisplay.textContent = "";
      neonateFlag.textContent = "N";
      pediatricFlag.textContent = "N";
      return;
    }

    var birth = new Date(dob);
    var start = new Date(ecmoDate);
    if (isNaN(birth) || isNaN(start) || birth > start) {
      ageDisplay.textContent = "（日付エラー）";
      daysOldDisplay.textContent = "";
      neonateFlag.textContent = "N";
      pediatricFlag.textContent = "N";
      return;
    }

    var diffTime = start.getTime() - birth.getTime();
    var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    var years = start.getFullYear() - birth.getFullYear();
    var months = start.getMonth() - birth.getMonth();
    var days = start.getDate() - birth.getDate();
    if (days < 0) {
      months -= 1;
      days += new Date(start.getFullYear(), start.getMonth(), 0).getDate();
    }
    if (months < 0) {
      years -= 1;
      months += 12;
    }

    ageDisplay.textContent = diffDays + " 日齢 / " + years + "歳 " + months + "か月";
    daysOldDisplay.textContent = diffDays;
    neonateFlag.textContent = diffDays <= 28 ? "Y" : "N";
    pediatricFlag.textContent = diffDays >= 29 ? "Y" : "N";
  }

  document.addEventListener("DOMContentLoaded", function () {
    var dobInput = document.getElementById("dob");
    var ecmoInput = document.getElementById("ecmo_start_date");
    if (dobInput) {
      dobInput.addEventListener("change", calculateAgeAndFlags);
    }
    if (ecmoInput) {
      ecmoInput.addEventListener("change", calculateAgeAndFlags);
    }
  });
</script>


  <!-- ▼ 登録ボタン -->
  <button type="button" id="submitButton">Firestoreに登録</button>

  <!-- ▼ 個別データExcel出力ボタン -->
  <button onclick="downloadExcel()">入力内容をExcelでダウンロード</button>
  <span style="display:block;">各施設で保管または印刷して1症例ずつデータを保管することを推奨します</span>
  <!-- ▼ 管理者全件出力 -->
  <button id="exportAllButton">登録済みデータをExcelでダウンロード（管理者用）</button>

  <fieldset>
    <legend>登録データ削除依頼</legend>
    <p>登録済みデータの削除を希望される場合は、以下の内容を入力のうえ「削除依頼メールを作成」ボタンを押してください。</p>
    <label for="delete_facility">施設名：</label>
    <input type="text" id="delete_facility" placeholder="例：○○大学病院"><br><br>

    <label for="delete_record_id">削除依頼ID：</label>
    <input type="text" id="delete_record_id" placeholder="例：123"><br>
    <small>※ 削除を希望する症例IDが不明な場合は未入力のままで構いません。</small><br><br>

    <label for="delete_record_date">入力日付：</label>
    <input type="date" id="delete_record_date"><br>
    <small>※ 削除を希望する症例の入力日をご記載ください。日付が不明な場合は未入力で構いません。</small><br><br>

    <label for="delete_note">自由記載：</label><br>
    <textarea id="delete_note" rows="4" cols="50" placeholder="削除理由などがあればご記入ください"></textarea><br><br>

    <label for="delete_attachment">添付画像（任意）：</label>
    <input type="file" id="delete_attachment" accept="image/*"><br>
    <small>※ 送信したい画像ファイルがあれば指定してください（1枚のみ）。</small><br><br>

    <button
      type="button"
      id="deleteRequestButton"
      data-delete-request-endpoint="https://asia-northeast1-pediatric-ecmo-registry.cloudfunctions.net/sendDeleteRequest"
    >削除依頼メールを送信</button>
    <p id="deleteRequestStatus" class="delete-request-status"></p>
  </fieldset>

  <script>
    window.readFileAsBase64 = function readFileAsBase64(file) {
      return new Promise(function (resolve, reject) {
        var reader = new FileReader();
        reader.onload = function () {
          var result = reader.result;
          if (typeof result === "string") {
            var commaIndex = result.indexOf(",");
            resolve(commaIndex >= 0 ? result.slice(commaIndex + 1) : result);
          } else {
            reject(new Error("ファイルの読み込みに失敗しました"));
          }
        };
        reader.onerror = function () {
          reject(new Error("ファイルの読み込みに失敗しました"));
        };
        reader.readAsDataURL(file);
      });
    };

    function getElementValue(id) {
      var element = document.getElementById(id);
      return element ? element.value : "";
    }

    function getTextContent(id) {
      var element = document.getElementById(id);
      return element ? element.textContent : "";
    }

    function getCheckedValues(name) {
      var nodes = document.querySelectorAll('input[name="' + name + '"]:checked');
      var values = [];
      for (var i = 0; i < nodes.length; i += 1) {
        values.push(nodes[i].value);
      }
      return values;
    }

    window.downloadExcel = function downloadExcel() {
      var hospitalEl = document.getElementById("hospital");
      if (!hospitalEl || hospitalEl.selectedIndex < 0) {
        alert("病院が選択されていません");
        return;
      }

      var selectedHospitalText = hospitalEl.options[hospitalEl.selectedIndex].text;
      var region = window.regionMap[selectedHospitalText] || "不明";

      var dobValue = getElementValue("dob");
      var ecmoStartValue = getElementValue("ecmo_start_date");
      var dob = dobValue ? new Date(dobValue) : new Date("invalid");
      var ecmoStart = ecmoStartValue ? new Date(ecmoStartValue) : new Date("invalid");
      var daysOld = "";
      var monthsOld = "";
      var yearsOld = "";
      var neonateFlag = "";
      if (!isNaN(dob) && !isNaN(ecmoStart)) {
        var diffMs = ecmoStart - dob;
        var diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        var diffMonths = Math.floor(diffDays / 30.4375);
        var diffYears = Math.floor(diffDays / 365.25);
        daysOld = diffDays;
        monthsOld = diffMonths;
        yearsOld = diffYears;
        neonateFlag = diffDays <= 28 ? "Y" : "N";
      }

      var ecmoTypeEl = document.getElementById("ecmo_type");
      var ecmoType = ecmoTypeEl ? ecmoTypeEl.value : "";

      var record = {
        region: region,
        hospital: selectedHospitalText,
        id: getElementValue("case_id"),
        sex: getElementValue("sex"),
        birth_date: dobValue,
        weight: getElementValue("weight"),
        days_old: daysOld,
        months_old: monthsOld,
        years_old: yearsOld,
        neonate_flag: neonateFlag,
        ecmo_type: ecmoType,
        ecmo_24h_survival: getElementValue("ecmo_24h_survival"),
        ecmo_off_reasons: getCheckedValues("ecmo_off_reason").join(", "),
        ecmo_mode: getElementValue("ecmo_mode"),
        pump_type: getElementValue("pump_type"),
        oxygenator_type: getElementValue("oxygenator"),
        ecmo_start_date: ecmoStartValue,
        ecmo_end_date: getElementValue("ecmo_end_date"),
        ecmo_days: getTextContent("ecmo_days_display"),
        anticoagulants: getCheckedValues("anticoagulants").join(", "),
        anticoag_monitoring: getCheckedValues("anticoag_monitoring").join(", "),
        icu_survival: getElementValue("icu_survival"),
        icu_discharge: getElementValue("icu_discharge_date"),
        hospital_survival: getElementValue("hospital_survival"),
        hospital_discharge: getElementValue("hospital_discharge_date")
      };

      if (ecmoType === "ecpr") {
        record.ecpr_icd10_code = getElementValue("ecpr_icd10_code");
        record.arrest_location = getElementValue("arrest_location");
        record.witnessed = getElementValue("witnessed");
        record.cannulation_location = getElementValue("cannulation_location");
        record.priming_fluid = getElementValue("priming_fluid");
        record.hypothermia = getElementValue("hypothermia");
        record.cpr_duration_min = getElementValue("cpr_duration");
      }

      var complicationMap = {
        oxygenator_failure: "oxygenator_fail",
        pump_failure: "pump_fail",
        cannula_problem: "cannula_problem",
        air_embolism: "air_embolism",
        seizure: "seizure",
        stroke: "stroke",
        ich_ct: "ich_ct",
        ich_echo: "ich_echo",
        brain_death: "brain_death",
        tamponade: "tamponade",
        cannula_bleeding: "cannula_bleeding",
        gi_bleed: "gi_bleed",
        amputation: "amputation"
      };

      for (var complicationId in complicationMap) {
        if (Object.prototype.hasOwnProperty.call(complicationMap, complicationId)) {
          var shortKey = complicationMap[complicationId];
          record[shortKey] = getElementValue(complicationId);
          record[shortKey + "_date"] = getElementValue(complicationId + "_date");
        }
      }

      var checkedCodes = getCheckedValues("icd10_codes");
      record.icd10_codes = checkedCodes;

      var headers = Object.keys(record);
      var values = [];
      for (var h = 0; h < headers.length; h += 1) {
        values.push(record[headers[h]]);
      }

      var ws = XLSX.utils.aoa_to_sheet([headers, values]);
      var wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ECMO_data");
      XLSX.writeFile(wb, "ecmo_registry.xlsx");
    };
  </script>

  <script>
    (function initialiseDeleteRequestForm() {
      var deleteRequestButton = document.getElementById("deleteRequestButton");
      if (!deleteRequestButton) {
        return;
      }

      var statusElement = document.getElementById("deleteRequestStatus");

      function setStatus(message, type) {
        if (!statusElement) {
          return;
        }

        var statusType = type || "info";
        statusElement.textContent = message;
        statusElement.classList.remove(
          "delete-request-status--info",
          "delete-request-status--warn",
          "delete-request-status--error"
        );

        var className = "delete-request-status--info";
        if (statusType === "error") {
          className = "delete-request-status--error";
        } else if (statusType === "warn") {
          className = "delete-request-status--warn";
        }
        statusElement.classList.add(className);
      }

      document.addEventListener("delete-request-callable-ready", function () {
        if (resolveEndpoint()) {
          return;
        }

        var statusText = statusElement ? statusElement.textContent || "" : "";
        if (!statusText) {
          setStatus(
            "Firebase Functions のコール可能エンドポイント経由で削除依頼メールを送信できます。",
            "info"
          );
        }
      });

      function resolveEndpoint() {
        var endpointFromWindow =
          typeof window.DELETE_REQUEST_ENDPOINT === "string"
            ? window.DELETE_REQUEST_ENDPOINT.replace(/^\s+|\s+$/g, "")
            : "";
        var endpointFromAttribute =
          deleteRequestButton.getAttribute("data-delete-request-endpoint") || "";
        endpointFromAttribute = endpointFromAttribute.replace(/^\s+|\s+$/g, "");
        return endpointFromWindow || endpointFromAttribute;
      }

      function resolveReprocessEndpoint() {
        var override =
          typeof window.DELETE_REQUEST_REPROCESS_ENDPOINT === "string"
            ? window.DELETE_REQUEST_REPROCESS_ENDPOINT.replace(/^\s+|\s+$/g, "")
            : "";
        if (override) {
          return override;
        }

        var endpoint = resolveEndpoint();
        if (!endpoint) {
          return "";
        }

        if (typeof URL === "function") {
          try {
            var parsed = new URL(endpoint);
            var segments = parsed.pathname.split("/");
            if (segments.length > 1) {
              segments[segments.length - 1] = "reprocessDeleteRequest";
              parsed.pathname = segments.join("/");
              return parsed.toString();
            }
          } catch (parseError) {
            if (typeof console !== "undefined" && console.warn) {
              console.warn("Failed to derive reprocess endpoint via URL", parseError);
            }
          }
        }

        if (endpoint.indexOf("/") === -1) {
          return endpoint;
        }

        return endpoint.replace(/\/?[^/]*$/, "/reprocessDeleteRequest");
      }

      var initialMessages = [];
      var initialStatusType = "info";
      var configuredEndpoint = resolveEndpoint();
      var reprocessEndpoint = resolveReprocessEndpoint();

      if (configuredEndpoint) {
        initialMessages.push("削除依頼メールの送信先URLは設定済みです。");
      } else {
        var missingMessage =
          "削除依頼メールの送信先URLが設定されていません。window.DELETE_REQUEST_ENDPOINT か data-delete-request-endpoint で設定するか、Firebase Functions のコール可能エンドポイントを利用してください。";
        initialMessages.push(missingMessage);
        initialStatusType = "warn";
        if (typeof console !== "undefined" && console.warn) {
          console.warn(missingMessage);
        }
      }

      if (reprocessEndpoint) {
        initialMessages.push("削除依頼のバックグラウンド処理用エンドポイントを確認しました。");
      }

      if (reprocessEndpoint) {
        initialMessages.push("削除依頼のバックグラウンド処理用エンドポイントを確認しました。");
      }

      if (typeof location !== "undefined" && location.protocol === "file:") {
        var fileWarning =
          "ローカルファイル（file://）から開いているため、動作しない場合は開発サーバー経由でアクセスしてください。";
        initialMessages.push(fileWarning);
        if (initialStatusType !== "error") {
          initialStatusType = "warn";
        }
        if (typeof console !== "undefined" && console.warn) {
          console.warn(
            "ローカルファイル（file://）から開いているため、ブラウザによっては Firebase SDK やモジュールが読み込めません。開発サーバーや Firebase Hosting からアクセスしてください。"
          );
        }
      }

      if (initialMessages.length > 0) {
        setStatus(initialMessages.join("\n"), initialStatusType);
      }

      if (typeof Promise !== "function") {
        setStatus("ご利用のブラウザでは削除依頼機能を使用できません。最新のブラウザでお試しください。", "error");
        return;
      }

      function getTrimmedValue(id) {
        var element = document.getElementById(id);
        if (!element || typeof element.value !== "string") {
          return "";
        }
        return element.value.replace(/^\s+|\s+$/g, "");
      }

      function clearValue(id) {
        var element = document.getElementById(id);
        if (element) {
          element.value = "";
        }
      }

      function clearDeleteRequestForm() {
        clearValue("delete_facility");
        clearValue("delete_record_id");
        clearValue("delete_record_date");
        clearValue("delete_note");
        var attachmentResetElement = document.getElementById("delete_attachment");
        if (attachmentResetElement) {
          attachmentResetElement.value = "";
        }
      }

      function handleAttachment(attachmentFile) {
        if (!attachmentFile) {
          return Promise.resolve(null);
        }
        if (typeof window.readFileAsBase64 !== "function") {
          return Promise.reject(new Error("添付ファイルを処理できませんでした。"));
        }
        return window.readFileAsBase64(attachmentFile).then(function (base64Content) {
          return {
            content: base64Content,
            filename: attachmentFile.name,
            type: attachmentFile.type || "application/octet-stream"
          };
        });
      }

      function sendRequest(endpoint, payload) {
        function sendWithXhr() {
          return new Promise(function (resolve, reject) {
            if (typeof XMLHttpRequest !== "function") {
              reject(new Error("リクエストを送信できませんでした。"));
              return;
            }

            var xhr = new XMLHttpRequest();
            xhr.open("POST", endpoint, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
              if (xhr.readyState === 4) {
                if (xhr.status >= 200 && xhr.status < 300) {
                  resolve({
                    ok: true,
                    status: xhr.status,
                    json: function () {
                      try {
                        return Promise.resolve(JSON.parse(xhr.responseText || "{}"));
                      } catch (parseError) {
                        return Promise.resolve({});
                      }
                    }
                  });
                } else {
                  reject(new Error("HTTP " + xhr.status));
                }
              }
            };
            xhr.onerror = function () {
              reject(new Error("ネットワークエラー"));
            };
            try {
              xhr.send(JSON.stringify(payload));
            } catch (sendError) {
              reject(sendError);
            }
          });
        }

        if (typeof window.fetch === "function") {
          return window
            .fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            })
            .catch(function (fetchError) {
              if (typeof console !== "undefined" && console.warn) {
                console.warn("Fetch delete request failed, retrying with XHR", fetchError);
              }
              return sendWithXhr();
            });
        }

        return sendWithXhr();
      }

      function formatTimestamp(timestampLike) {
        if (!timestampLike) {
          return "";
        }

        try {
          if (typeof timestampLike.toDate === "function") {
            return timestampLike.toDate().toLocaleString("ja-JP");
          }

          if (
            typeof timestampLike.seconds === "number" &&
            typeof timestampLike.nanoseconds === "number"
          ) {
            var millis = timestampLike.seconds * 1000 + Math.floor(timestampLike.nanoseconds / 1000000);
            return new Date(millis).toLocaleString("ja-JP");
          }
        } catch (timestampError) {
          if (typeof console !== "undefined" && console.warn) {
            console.warn("Failed to format Firestore timestamp", timestampError);
          }
        }

        if (typeof timestampLike === "string") {
          return timestampLike;
        }

        return "";
      }

      function buildAttemptContext(statusData) {
        if (!statusData || typeof statusData !== "object") {
          return "";
        }

        var lines = [];
        if (typeof statusData.attemptCount === "number") {
          lines.push("試行回数: " + statusData.attemptCount);
        }
        if (statusData.lastAttemptAt) {
          var lastAttempt = formatTimestamp(statusData.lastAttemptAt);
          if (lastAttempt) {
            lines.push("最終試行: " + lastAttempt);
          }
        }
        if (statusData.processingStartedAt) {
          var startedAt = formatTimestamp(statusData.processingStartedAt);
          if (startedAt) {
            lines.push("処理開始: " + startedAt);
          }
        }
        if (statusData.processedAt) {
          var processedAt = formatTimestamp(statusData.processedAt);
          if (processedAt) {
            lines.push("処理完了: " + processedAt);
          }
        }

        return lines.length > 0 ? "\n" + lines.join("\n") : "";
      }

      async function triggerDeleteRequestProcessing(docId) {
        if (!docId) {
          return;
        }

        if (typeof window.callReprocessDeleteRequest === "function") {
          try {
            var callableResult = await window.callReprocessDeleteRequest({
              docId: docId
            });
            if (
              callableResult &&
              typeof callableResult === "object" &&
              typeof callableResult.status === "string" &&
              typeof console !== "undefined" &&
              console.info
            ) {
              console.info(
                "Delete request reprocess callable response",
                callableResult
              );
            }
            return;
          } catch (callableError) {
            if (typeof console !== "undefined" && console.warn) {
              console.warn(
                "Failed to trigger delete request reprocessing via callable",
                callableError
              );
            }
          }
        }

        if (!reprocessEndpoint) {
          return;
        }

        try {
          var triggerResponse = await sendRequest(reprocessEndpoint, {
            docId: docId
          });

          if (!triggerResponse || typeof triggerResponse.ok !== "boolean") {
            return;
          }

          if (!triggerResponse.ok) {
            if (typeof console !== "undefined" && console.warn) {
              console.warn(
                "Failed to trigger delete request reprocessing",
                triggerResponse.status
              );
            }
            return;
          }

          if (typeof triggerResponse.json === "function") {
            triggerResponse
              .json()
              .then(function (triggerData) {
                if (
                  triggerData &&
                  typeof triggerData === "object" &&
                  typeof triggerData.status === "string" &&
                  typeof console !== "undefined" &&
                  console.info
                ) {
                  console.info("Delete request reprocess response", triggerData);
                }
              })
              .catch(function () {
                /* ignore JSON parse errors */
              });
          }
        } catch (triggerError) {
          if (typeof console !== "undefined" && console.warn) {
            console.warn("Unable to trigger delete request reprocessing", triggerError);
          }
        }
      }

      async function attemptFirestoreFallback(payload, originalError) {
        var outcome = { attempted: false, success: false, errorMessage: null };

        if (!payload || typeof window.submitDeleteRequestViaFirestore !== "function") {
          return outcome;
        }

        outcome.attempted = true;

        var originalErrorMessage = "";
        if (originalError && typeof originalError.message === "string") {
          originalErrorMessage = originalError.message;
        }

        try {
          var warnMessage = "メール送信に失敗しました。";
          if (originalErrorMessage) {
            warnMessage += "（エラー: " + originalErrorMessage + "）";
          }
          warnMessage += " 削除依頼をFirestoreに登録し、担当者への送信を再試行します。";
          setStatus(warnMessage, "warn");

          var submissionResult = await window.submitDeleteRequestViaFirestore(payload, {
            failureReason: originalErrorMessage
          });
          clearDeleteRequestForm();
          outcome.success = true;

          var docId = null;
          if (submissionResult && typeof submissionResult === "object") {
            if (typeof submissionResult.docId === "string") {
              docId = submissionResult.docId;
            } else if (typeof submissionResult.id === "string") {
              docId = submissionResult.id;
            }
          }

          function appendDocReference(message) {
            var suffix = docId ? "\n参照ID: " + docId : "";
            return message + suffix;
          }

          var initialFailureInfo = originalErrorMessage
            ? "\n初回エラー: " + originalErrorMessage
            : "";

          function notifyCompletion(statusData) {
            var completionMessage =
              "送信処理が完了しました。ありがとうございました。" + initialFailureInfo;
            completionMessage = appendDocReference(completionMessage);
            completionMessage += buildAttemptContext(statusData);
            setStatus(completionMessage, "info");
            alert(completionMessage);
          }

          function notifyError(message, statusData) {
            var finalMessage = message || "Firestore 経由の送信処理に失敗しました。";
            if (initialFailureInfo) {
              finalMessage += initialFailureInfo;
            }
            finalMessage = appendDocReference(finalMessage);
            finalMessage += buildAttemptContext(statusData);
            setStatus("❌ " + finalMessage, "error");
            alert("❌ " + finalMessage);
          }

          function notifyTimeout(statusData) {
            var timeoutMessage =
              "送信処理の確認がタイムアウトしました。しばらくしてからメール受信箱をご確認ください。" +
              initialFailureInfo;
            timeoutMessage = appendDocReference(timeoutMessage);
            timeoutMessage += buildAttemptContext(statusData);
            setStatus(timeoutMessage, "warn");
            alert(timeoutMessage);
          }

          function notifyQueuedWithoutWatcher() {
            var queuedMessage =
              "削除依頼を受け付けました。担当者への送信結果は後ほどメール受信箱をご確認ください。" +
              initialFailureInfo;
            queuedMessage = appendDocReference(queuedMessage);
            setStatus(queuedMessage, "warn");
            alert(queuedMessage);
          }

          if (docId && typeof window.watchDeleteRequestStatus === "function") {
            setStatus(
              appendDocReference(
                "削除依頼を受け付けました。送信処理の完了を確認しています…" +
                  initialFailureInfo
              ),
              "warn"
            );

            if (typeof console !== "undefined" && console.info) {
              console.info("Queued delete request for Firestore processing", { docId: docId });
            }

            var unsubscribe = null;
            var hasFinalised = false;
            var timeoutId = null;
            var latestStatusData = null;

            function finalise(callback) {
              if (hasFinalised) {
                return;
              }
              hasFinalised = true;
              if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
              }
              if (typeof unsubscribe === "function") {
                unsubscribe();
                unsubscribe = null;
              }
              callback(latestStatusData);
            }

            unsubscribe = window.watchDeleteRequestStatus(
              docId,
              function onUpdate(statusData) {
                latestStatusData = statusData || null;
                if (!statusData) {
                  finalise(function (finalStatus) {
                    notifyError("削除依頼のステータスを取得できませんでした。", finalStatus);
                  });
                  return;
                }

                var currentStatus = statusData.status || "";
                if (currentStatus === "sent") {
                  finalise(function (finalStatus) {
                    notifyCompletion(finalStatus);
                  });
                } else if (currentStatus === "error") {
                  var statusErrorMessage =
                    statusData.errorMessage && typeof statusData.errorMessage === "string"
                      ? statusData.errorMessage.trim()
                      : "";
                  finalise(function (finalStatus) {
                    notifyError(
                      statusErrorMessage
                        ? "メール送信に失敗しました: " + statusErrorMessage
                        : "メール送信に失敗しました。詳細は管理者にお問い合わせください。",
                      finalStatus
                    );
                  });
                } else {
                  var progressMessage =
                    "削除依頼を受け付けました。現在送信処理を実行しています";
                  if (currentStatus) {
                    progressMessage += "（ステータス: " + currentStatus + "）";
                  }
                  progressMessage += "。";
                  if (statusData.lastError) {
                    progressMessage += "\n初回エラー: " + statusData.lastError;
                  }
                  if (statusData.errorMessage && statusData.errorMessage !== statusData.lastError) {
                    progressMessage += "\n最新エラー: " + statusData.errorMessage;
                  }
                  progressMessage += buildAttemptContext(statusData);
                  progressMessage = appendDocReference(progressMessage);
                  setStatus(progressMessage, "warn");
                }
              },
              function onListenerError(listenerError) {
                var listenerMessage =
                  listenerError && typeof listenerError.message === "string"
                    ? listenerError.message
                    : "削除依頼のステータス監視中にエラーが発生しました。";
                finalise(function (finalStatus) {
                  notifyError(listenerMessage, finalStatus);
                });
              }
            );

            triggerDeleteRequestProcessing(docId);

            timeoutId = setTimeout(function () {
              finalise(function (finalStatus) {
                notifyTimeout(finalStatus);
              });
            }, 5 * 60 * 1000);
          } else {
            triggerDeleteRequestProcessing(docId);
            notifyQueuedWithoutWatcher();
          }

          return outcome;
        } catch (firestoreError) {
          if (typeof console !== "undefined" && console.error) {
            console.error("Firestore fallback error", firestoreError);
          }
          var fallbackMessage =
            (firestoreError && firestoreError.message) ||
            "Firestore への登録に失敗しました。";
          outcome.errorMessage = fallbackMessage;
          return outcome;
        }
      }

      deleteRequestButton.addEventListener("click", async function () {
        var deleteRequestEndpoint = resolveEndpoint();
        var facility = getTrimmedValue("delete_facility");
        var recordId = getTrimmedValue("delete_record_id");
        var recordDateElement = document.getElementById("delete_record_date");
        var recordDate = recordDateElement ? recordDateElement.value : "";
        var note = getTrimmedValue("delete_note");
        var attachmentInput = document.getElementById("delete_attachment");
        var attachmentFile = attachmentInput && attachmentInput.files ? attachmentInput.files[0] : null;

        if (!facility) {
          var facilityMessage = "施設名を入力してください。";
          setStatus(facilityMessage, "error");
          alert(facilityMessage);
          return;
        }

        if (!recordId && !recordDate) {
          var idMessage = "削除依頼IDまたは入力日付のいずれかを入力してください。";
          setStatus(idMessage, "error");
          alert(idMessage);
          return;
        }

        var originalText = deleteRequestButton.textContent;
        deleteRequestButton.disabled = true;
        deleteRequestButton.textContent = "送信中...";

        function restoreButton() {
          deleteRequestButton.disabled = false;
          deleteRequestButton.textContent = originalText;
        }

        var attachmentPayload = null;
        var requestPayload = null;

        try {
          attachmentPayload = await handleAttachment(attachmentFile);

          requestPayload = {
            facility: facility,
            recordId: recordId,
            recordDate: recordDate,
            note: note,
            attachment: attachmentPayload
          };

          var canUseCallable =
            typeof window.callSendDeleteRequest === "function";

          if (!canUseCallable && !deleteRequestEndpoint) {
            var missingEndpointMessage =
              "削除依頼メール送信先の URL が設定されていません。ボタン横の案内を参照して設定するか、Firebase Functions のコール可能エンドポイントをご利用ください。";
            setStatus(missingEndpointMessage, "error");
            throw new Error(
              "削除依頼メール送信先の URL が設定されていません。"
            );
          }

          setStatus("削除依頼メールを送信中です…", "warn");

          var response = null;
          var lastError = null;

          if (canUseCallable) {
            try {
              response = await window.callSendDeleteRequest(requestPayload);
            } catch (callableSendError) {
              lastError = callableSendError;
              if (typeof console !== "undefined" && console.warn) {
                console.warn("Callable delete request failed", callableSendError);
              }
            }
          }

          if (!response && deleteRequestEndpoint) {
            try {
              response = await sendRequest(deleteRequestEndpoint, requestPayload);
            } catch (httpError) {
              lastError = httpError;
              if (typeof console !== "undefined" && console.warn) {
                console.warn("HTTP delete request failed", httpError);
              }
            }
          }

          if (!response) {
            throw lastError || new Error("削除依頼メールの送信に失敗しました。");
          }

          if (!response.ok) {
            var errorMessage = "HTTP " + response.status;
            if (typeof response.json === "function") {
              try {
                var errorData = await response.json();
                if (errorData && errorData.error) {
                  errorMessage = errorData.error;
                }
              } catch (parseError) {
                if (typeof console !== "undefined" && console.warn) {
                  console.warn("Failed to parse error response", parseError);
                }
              }
            }
            throw new Error(errorMessage);
          }

          setStatus("送信が完了しました。ありがとうございました。", "info");
          alert("送信が完了しました。ありがとうございました。");
          clearDeleteRequestForm();
        } catch (error) {
          if (typeof console !== "undefined" && console.error) {
            console.error("SendGrid error", error);
          }

          var fallbackOutcome = await attemptFirestoreFallback(requestPayload, error);

          if (fallbackOutcome && fallbackOutcome.success) {
            return;
          }

          var finalErrorMessage = fallbackOutcome && fallbackOutcome.attempted && fallbackOutcome.errorMessage
            ? "❌ Firestore への登録に失敗しました: " + fallbackOutcome.errorMessage
            : "❌ メールの送信に失敗しました: " + (error && error.message ? error.message : "Unknown error");
          setStatus(finalErrorMessage, "error");
          alert(finalErrorMessage);
        } finally {
          restoreButton();
        }
      });
    })();
  </script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js";
import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.19.3/package/xlsx.mjs";

// Firebase設定（自分の設定でOK）
const firebaseConfig = {
  apiKey: "AIzaSyCTXgF0cgJ3Sz0gF0AI6bXDibIesXVI9Ck",
  authDomain: "pediatric-ecmo-registry.firebaseapp.com",
  projectId: "pediatric-ecmo-registry",
  storageBucket: "pediatric-ecmo-registry.appspot.com",
  messagingSenderId: "868465318743",
  appId: "1:868465318743:web:6a4d522d1a716faa8afc12",
  measurementId: "G-JBJ9F9C1RK"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const functionsRegion = "asia-northeast1";
const functionsInstance = getFunctions(app, functionsRegion);

function normaliseCallableError(error) {
  var message = "";
  if (error && typeof error.details === "string" && error.details) {
    message = error.details;
  } else if (error && typeof error.message === "string" && error.message) {
    message = error.message;
  }

  var normalised = new Error(message || "Callable request failed");
  if (error && error.code) {
    normalised.code = error.code;
  }
  normalised.originalError = error;
  return normalised;
}

window.callSendDeleteRequest = async function callSendDeleteRequest(payload) {
  const callable = httpsCallable(functionsInstance, "sendDeleteRequestCallable");
  try {
    const result = await callable(payload || {});
    const responseData = result && result.data ? result.data : { success: true };
    return {
      ok: true,
      status: 200,
      json: function () {
        return Promise.resolve(responseData);
      }
    };
  } catch (error) {
    throw normaliseCallableError(error);
  }
};

window.callReprocessDeleteRequest = async function callReprocessDeleteRequest(
  payload
) {
  const callable = httpsCallable(
    functionsInstance,
    "reprocessDeleteRequestCallable"
  );
  try {
    const result = await callable(payload || {});
    return result && result.data ? result.data : null;
  } catch (error) {
    throw normaliseCallableError(error);
  }
};

document.dispatchEvent(new CustomEvent("delete-request-callable-ready"));

window.submitDeleteRequestViaFirestore = async function submitDeleteRequestViaFirestore(
  payload,
  options
) {
  if (!payload || typeof payload !== "object") {
    throw new Error("削除依頼の内容が不正です。");
  }

  var failureReason = "";
  if (options && typeof options.failureReason === "string") {
    failureReason = options.failureReason.trim();
  }

  const trimValue = value => (typeof value === "string" ? value.trim() : "");
  const facility = trimValue(payload.facility);
  const recordId = trimValue(payload.recordId);
  const recordDate = trimValue(payload.recordDate);
  const note = typeof payload.note === "string" ? payload.note : "";

  if (!facility) {
    throw new Error("施設名は必須です。");
  }

  if (!recordId && !recordDate) {
    throw new Error("削除依頼IDまたは入力日付のいずれかを入力してください。");
  }

  let attachment = null;
  if (payload.attachment && payload.attachment.content) {
    attachment = {
      content: String(payload.attachment.content),
      filename: payload.attachment.filename ? String(payload.attachment.filename) : "attachment",
      type: payload.attachment.type ? String(payload.attachment.type) : "application/octet-stream"
    };

    var approximateBytes = Math.ceil((attachment.content.length * 3) / 4);
    if (approximateBytes > 900000) {
      throw new Error("添付ファイルが大きすぎます。1MB未満のファイルをご利用ください。");
    }
  }

  const docPayload = {
    facility,
    recordId,
    recordDate,
    note,
    attachment,
    status: "pending",
    submittedAt: new Date().toISOString(),
    lastError: failureReason || null
  };

  const docRef = await addDoc(collection(db, "delete_requests"), docPayload);
  return { docId: docRef.id };
};

window.watchDeleteRequestStatus = function watchDeleteRequestStatus(
  docId,
  onUpdate,
  onError
) {
  if (!docId) {
    return function noop() {};
  }

  try {
    const documentRef = doc(db, "delete_requests", docId);
    return onSnapshot(
      documentRef,
      snapshot => {
        if (typeof onUpdate === "function") {
          onUpdate(snapshot.exists() ? snapshot.data() : null);
        }
      },
      error => {
        if (typeof onError === "function") {
          onError(error);
        }
      }
    );
  } catch (listenerError) {
    if (typeof onError === "function") {
      onError(listenerError);
    }
    return function noop() {};
  }
};

window.submitDeleteRequestViaFirestore = async function submitDeleteRequestViaFirestore(
  payload,
  options
) {
  if (!payload || typeof payload !== "object") {
    throw new Error("削除依頼の内容が不正です。");
  }

  var failureReason = "";
  if (options && typeof options.failureReason === "string") {
    failureReason = options.failureReason.trim();
  }

  const trimValue = value => (typeof value === "string" ? value.trim() : "");
  const facility = trimValue(payload.facility);
  const recordId = trimValue(payload.recordId);
  const recordDate = trimValue(payload.recordDate);
  const note = typeof payload.note === "string" ? payload.note : "";

  if (!facility) {
    throw new Error("施設名は必須です。");
  }

  if (!recordId && !recordDate) {
    throw new Error("削除依頼IDまたは入力日付のいずれかを入力してください。");
  }

  let attachment = null;
  if (payload.attachment && payload.attachment.content) {
    attachment = {
      content: String(payload.attachment.content),
      filename: payload.attachment.filename ? String(payload.attachment.filename) : "attachment",
      type: payload.attachment.type ? String(payload.attachment.type) : "application/octet-stream"
    };

    var approximateBytes = Math.ceil((attachment.content.length * 3) / 4);
    if (approximateBytes > 900000) {
      throw new Error("添付ファイルが大きすぎます。1MB未満のファイルをご利用ください。");
    }
  }

  const docPayload = {
    facility,
    recordId,
    recordDate,
    note,
    attachment,
    status: "pending",
    submittedAt: new Date().toISOString(),
    lastError: failureReason || null
  };

  const docRef = await addDoc(collection(db, "delete_requests"), docPayload);
  return { docId: docRef.id };
};

window.watchDeleteRequestStatus = function watchDeleteRequestStatus(
  docId,
  onUpdate,
  onError
) {
  if (!docId) {
    return function noop() {};
  }

  try {
    const documentRef = doc(db, "delete_requests", docId);
    return onSnapshot(
      documentRef,
      snapshot => {
        if (typeof onUpdate === "function") {
          onUpdate(snapshot.exists() ? snapshot.data() : null);
        }
      },
      error => {
        if (typeof onError === "function") {
          onError(error);
        }
      }
    );
  } catch (listenerError) {
    if (typeof onError === "function") {
      onError(listenerError);
    }
    return function noop() {};
  }
};

window.submitDeleteRequestViaFirestore = async function submitDeleteRequestViaFirestore(
  payload,
  options
) {
  if (!payload || typeof payload !== "object") {
    throw new Error("削除依頼の内容が不正です。");
  }

  var failureReason = "";
  if (options && typeof options.failureReason === "string") {
    failureReason = options.failureReason.trim();
  }

  const trimValue = value => (typeof value === "string" ? value.trim() : "");
  const facility = trimValue(payload.facility);
  const recordId = trimValue(payload.recordId);
  const recordDate = trimValue(payload.recordDate);
  const note = typeof payload.note === "string" ? payload.note : "";

  if (!facility) {
    throw new Error("施設名は必須です。");
  }

  if (!recordId && !recordDate) {
    throw new Error("削除依頼IDまたは入力日付のいずれかを入力してください。");
  }

  let attachment = null;
  if (payload.attachment && payload.attachment.content) {
    attachment = {
      content: String(payload.attachment.content),
      filename: payload.attachment.filename ? String(payload.attachment.filename) : "attachment",
      type: payload.attachment.type ? String(payload.attachment.type) : "application/octet-stream"
    };

    var approximateBytes = Math.ceil((attachment.content.length * 3) / 4);
    if (approximateBytes > 900000) {
      throw new Error("添付ファイルが大きすぎます。1MB未満のファイルをご利用ください。");
    }
  }

  const docPayload = {
    facility,
    recordId,
    recordDate,
    note,
    attachment,
    status: "pending",
    submittedAt: new Date().toISOString(),
    lastError: failureReason || null
  };

  const docRef = await addDoc(collection(db, "delete_requests"), docPayload);
  return { docId: docRef.id };
};

window.watchDeleteRequestStatus = function watchDeleteRequestStatus(
  docId,
  onUpdate,
  onError
) {
  if (!docId) {
    return function noop() {};
  }

  try {
    const documentRef = doc(db, "delete_requests", docId);
    return onSnapshot(
      documentRef,
      snapshot => {
        if (typeof onUpdate === "function") {
          onUpdate(snapshot.exists() ? snapshot.data() : null);
        }
      },
      error => {
        if (typeof onError === "function") {
          onError(error);
        }
      }
    );
  } catch (listenerError) {
    if (typeof onError === "function") {
      onError(listenerError);
    }
    return function noop() {};
  }
};

window.submitDeleteRequestViaFirestore = async function submitDeleteRequestViaFirestore(
  payload,
  options
) {
  if (!payload || typeof payload !== "object") {
    throw new Error("削除依頼の内容が不正です。");
  }

  var failureReason = "";
  if (options && typeof options.failureReason === "string") {
    failureReason = options.failureReason.trim();
  }

  const trimValue = value => (typeof value === "string" ? value.trim() : "");
  const facility = trimValue(payload.facility);
  const recordId = trimValue(payload.recordId);
  const recordDate = trimValue(payload.recordDate);
  const note = typeof payload.note === "string" ? payload.note : "";

  if (!facility) {
    throw new Error("施設名は必須です。");
  }

  if (!recordId && !recordDate) {
    throw new Error("削除依頼IDまたは入力日付のいずれかを入力してください。");
  }

  let attachment = null;
  if (payload.attachment && payload.attachment.content) {
    attachment = {
      content: String(payload.attachment.content),
      filename: payload.attachment.filename ? String(payload.attachment.filename) : "attachment",
      type: payload.attachment.type ? String(payload.attachment.type) : "application/octet-stream"
    };

    var approximateBytes = Math.ceil((attachment.content.length * 3) / 4);
    if (approximateBytes > 900000) {
      throw new Error("添付ファイルが大きすぎます。1MB未満のファイルをご利用ください。");
    }
  }

  const docPayload = {
    facility,
    recordId,
    recordDate,
    note,
    attachment,
    status: "pending",
    submittedAt: new Date().toISOString(),
    lastError: failureReason || null
  };

  const docRef = await addDoc(collection(db, "delete_requests"), docPayload);
  return { docId: docRef.id };
};

window.watchDeleteRequestStatus = function watchDeleteRequestStatus(
  docId,
  onUpdate,
  onError
) {
  if (!docId) {
    return function noop() {};
  }

  try {
    const documentRef = doc(db, "delete_requests", docId);
    return onSnapshot(
      documentRef,
      snapshot => {
        if (typeof onUpdate === "function") {
          onUpdate(snapshot.exists() ? snapshot.data() : null);
        }
      },
      error => {
        if (typeof onError === "function") {
          onError(error);
        }
      }
    );
  } catch (listenerError) {
    if (typeof onError === "function") {
      onError(listenerError);
    }
    return function noop() {};
  }
};

// ▼ 登録ボタン
document.getElementById("submitButton").addEventListener("click", async () => {
  // 必要なデータ取得
  const hospitalEl = document.getElementById("hospital");
  const selectedHospitalText = hospitalEl.selectedOptions[0].text;
  const region = window.regionMap[selectedHospitalText] || "不明";
  const dob = new Date(document.getElementById("dob").value);
  const ecmoStart = new Date(document.getElementById("ecmo_start_date").value);
  let daysOld = "", monthsOld = "", yearsOld = "", neonateFlag = "";
  if (!isNaN(dob) && !isNaN(ecmoStart)) {
    const diffMs = ecmoStart - dob;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffMonths = Math.floor(diffDays / 30.4375);
    const diffYears = Math.floor(diffDays / 365.25);
    daysOld = diffDays;
    monthsOld = diffMonths;
    yearsOld = diffYears;
    neonateFlag = diffDays <= 28 ? "Y" : "N";
  }
  const ecmoType = document.getElementById("ecmo_type")?.value || "";

  const selectedCodes = Array.from(document.querySelectorAll('input[name="icd10_codes"]:checked')).map(cb => cb.value);

  const record = {
    region: region,
    hospital: selectedHospitalText,
    id: document.getElementById("case_id").value,
    sex: document.getElementById("sex").value,
    birth_date: document.getElementById("dob").value,
    weight: document.getElementById("weight").value,
    days_old: daysOld,
    months_old: monthsOld,
    years_old: yearsOld,
    neonate_flag: neonateFlag,
    ecmo_type: ecmoType,
    icd10_codes: selectedCodes,
    ecmo_24h_survival: document.getElementById("ecmo_24h_survival")?.value || "",
    ecmo_off_reasons: Array.from(document.querySelectorAll('input[name="ecmo_off_reason"]:checked')).map(cb => cb.value).join(", ") || "",
    ...(ecmoType === "ecpr" && {
      ecpr_icd10_code: document.getElementById("ecpr_icd10_code")?.value || "",
      arrest_location: document.getElementById("arrest_location")?.value || "",
      witnessed: document.getElementById("witnessed")?.value || "",
      cannulation_location: document.getElementById("cannulation_location")?.value || "",
      priming_fluid: document.getElementById("priming_fluid")?.value || "",
      hypothermia: document.getElementById("hypothermia")?.value || "",
      cpr_duration_min: document.getElementById("cpr_duration")?.value || ""
    }),
    ecmo_mode: document.getElementById("ecmo_mode").value,
    pump_type: document.getElementById("pump_type").value,
    oxygenator_type: document.getElementById("oxygenator").value,
    ecmo_start_date: document.getElementById("ecmo_start_date").value,
    ecmo_end_date: document.getElementById("ecmo_end_date").value,
    ecmo_days: document.getElementById("ecmo_days_display").textContent,
    anticoagulants: Array.from(document.querySelectorAll('input[name="anticoagulants"]:checked')).map(cb => cb.value).join(", ") || "",
    anticoag_monitoring: Array.from(document.querySelectorAll('input[name="anticoag_monitoring"]:checked')).map(cb => cb.value).join(", ") || "",
    icu_survival: document.getElementById("icu_survival").value,
    icu_discharge: document.getElementById("icu_discharge_date").value,
    hospital_survival: document.getElementById("hospital_survival").value,
    hospital_discharge: document.getElementById("hospital_discharge_date").value
  };

  // 合併症
  const complicationMap = {
    oxygenator_failure: 'oxygenator_fail',
    pump_failure: 'pump_fail',
    cannula_problem: 'cannula_problem',
    air_embolism: 'air_embolism',
    seizure: 'seizure',
    stroke: 'stroke',
    ich_ct: 'ich_ct',
    ich_echo: 'ich_echo',
    brain_death: 'brain_death',
    tamponade: 'tamponade',
    cannula_bleeding: 'cannula_bleeding',
    gi_bleed: 'gi_bleed',
    amputation: 'amputation'
  };
  Object.entries(complicationMap).forEach(([id, shortKey]) => {
    record[shortKey] = document.getElementById(id)?.value || "";
    record[`${shortKey}_date`] = document.getElementById(id + "_date")?.value || "";
  });

  // Firestoreに登録
  try {
    await addDoc(collection(db, "ecmo_registry"), record);
    alert("✅ 登録が完了しました！");
    document.querySelectorAll('input[name="icd10_codes"]').forEach(cb => {
      cb.checked = false;
    });
  } catch (e) {
    alert("❌ 登録に失敗しました: " + e.message);
    console.error(e);
  }
});

// ▼ 管理者全件エクセル出力ボタン
document.getElementById("exportAllButton").addEventListener("click", async () => {
  const password = prompt("管理者パスワードを入力してください：");
  if (password !== "pecmoREGI") {
    alert("❌ パスワードが違います");
    return;
  }
  try {
    const snapshot = await getDocs(collection(db, "ecmo_registry"));
    const records = [];
    snapshot.forEach(doc => records.push(doc.data()));

    if (records.length === 0) {
      alert("📭 登録されたデータがありません");
      return;
    }

    const ws = XLSX.utils.json_to_sheet(records);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ECMO_Registry");
    XLSX.writeFile(wb, "ecmo_registry_all.xlsx");
    alert("✅ 登録データをExcelファイルとして保存しました！");
  } catch (e) {
    console.error("❌ データ取得に失敗しました：", e);
    alert("❌ ダウンロードに失敗しました");
  }
});
</script>


</body>
</html>
